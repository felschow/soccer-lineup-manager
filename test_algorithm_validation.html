<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algorithm Validation Test - Soccer Lineup Manager</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f2f5; }
        .test-container { max-width: 1400px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .test-button { margin: 8px; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .test-primary { background: #3b82f6; color: white; }
        .test-success { background: #10b981; color: white; }
        .test-danger { background: #ef4444; color: white; }
        .test-warning { background: #f59e0b; color: white; }
        .test-result { margin: 12px 0; padding: 16px; border-radius: 8px; border-left: 4px solid; }
        .result-success { background: #ecfdf5; border-color: #10b981; color: #065f46; }
        .result-error { background: #fef2f2; border-color: #ef4444; color: #991b1b; }
        .result-warning { background: #fffbeb; border-color: #f59e0b; color: #92400e; }
        .result-info { background: #eff6ff; border-color: #3b82f6; color: #1e40af; }
        .lineup-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 12px; margin: 20px 0; }
        .period-card { border: 2px solid #e5e7eb; padding: 12px; border-radius: 8px; background: #f9fafb; }
        .period-title { font-weight: bold; margin-bottom: 10px; color: #374151; text-align: center; }
        .position-list { font-size: 11px; line-height: 1.4; }
        .bench-list { color: #dc2626; font-weight: 500; margin-top: 8px; }
        .jersey-list { color: #7c3aed; font-weight: 500; margin-top: 4px; }
        .rule-validation { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin: 20px 0; }
        .rule-card { background: #f8fafc; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .rule-header { font-weight: bold; color: #1f2937; margin-bottom: 8px; }
        .player-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin: 20px 0; }
        .player-card { background: #f1f5f9; padding: 12px; border-radius: 6px; border: 1px solid #cbd5e1; }
        .violation { color: #dc2626; font-weight: bold; }
        .success { color: #059669; font-weight: bold; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🔬 Algorithm Validation Test Suite</h1>
        <p class="text-gray-600">Comprehensive testing of the new rule-based autofill algorithm</p>
        
        <div class="test-section">
            <h2>🚀 New Algorithm Testing</h2>
            <button class="test-button test-primary" onclick="runFullValidation()">🧪 Run Complete Validation</button>
            <button class="test-button test-success" onclick="testRuleCompliance()">📋 Test All 5 Rules</button>
            <button class="test-button test-warning" onclick="stressTestAlgorithm()">⚡ Stress Test (10 runs)</button>
            <button class="test-button test-danger" onclick="resetAndClear()">🧹 Clear All Data</button>
        </div>

        <div class="test-section">
            <h2>📊 Test Results</h2>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h2>📋 Rule Validation Details</h2>
            <div id="ruleValidation"></div>
        </div>

        <div class="test-section">
            <h2>🏃‍♀️ Player Statistics</h2>
            <div id="playerStats"></div>
        </div>

        <div class="test-section">
            <h2>📈 Lineup Visualization</h2>
            <div id="lineupDisplay"></div>
        </div>
    </div>

    <!-- Include all modules -->
    <script src="js/config.js"></script>
    <script src="js/toastManager.js"></script>
    <script src="js/lineupManager.js"></script>
    <script src="js/historyManager.js"></script>
    <script src="js/enhancedStats.js"></script>
    <script src="js/uiManager.js"></script>
    <script src="js/dragDrop.js"></script>
    <script src="js/mobileEnhancements.js"></script>
    <script src="js/autoFill.js"></script>
    <script src="js/exportUtils.js"></script>

    <script>
        let testResults = [];
        let currentTestRun = 1;
        
        function addTestResult(test, status, details, data = null) {
            testResults.push({ 
                test, 
                status, 
                details, 
                data, 
                timestamp: new Date(),
                run: currentTestRun
            });
            updateTestDisplay();
        }
        
        function updateTestDisplay() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = testResults.slice(-10).map(result => `
                <div class="test-result result-${result.status}">
                    <strong>Run ${result.run}: ${result.test}</strong> - ${result.status.toUpperCase()}
                    <br><span style="font-size: 14px;">${result.details}</span>
                    ${result.data ? `<details style="margin-top: 8px;"><summary>Data</summary><pre style="font-size: 10px; margin: 5px 0; max-height: 200px; overflow-y: auto;">${JSON.stringify(result.data, null, 2)}</pre></details>` : ''}
                </div>
            `).join('');
        }

        // Initialize modules
        document.addEventListener('DOMContentLoaded', () => {
            try {
                ToastManager.init();
                LineupManager.init();
                HistoryManager.init();
                EnhancedStats.init();
                MobileEnhancements.init();
                
                addTestResult('System Initialization', 'success', 'All modules loaded successfully for algorithm validation');
            } catch (error) {
                addTestResult('System Initialization', 'error', `Failed to initialize: ${error.message}`);
            }
        });

        // Main validation function
        function runFullValidation() {
            currentTestRun++;
            addTestResult('Full Validation Started', 'info', 'Starting comprehensive algorithm validation...');
            
            try {
                // Clear everything first
                LineupManager.clearAllPeriods();
                
                // Run the new algorithm
                AutoFillManager.autoFillAll();
                
                // Validate all rules
                const violations = validateAllFiveRules();
                
                if (violations.length === 0) {
                    addTestResult('Algorithm Validation', 'success', 'All 5 rules successfully enforced! New algorithm works perfectly.', { violations: [] });
                    ToastManager.success('✅ Perfect! All rules followed successfully!', 5000);
                } else {
                    addTestResult('Algorithm Validation', 'warning', `${violations.length} rule violations found`, { violations });
                    ToastManager.warning(`⚠️ ${violations.length} violations found`, 4000);
                }
                
                // Display results
                displayRuleValidation(violations);
                displayPlayerStatistics();
                displayLineupVisualization();
                
            } catch (error) {
                addTestResult('Algorithm Validation', 'error', `Algorithm failed: ${error.message}`);
                ToastManager.error('Algorithm execution failed', 4000);
            }
        }

        // Validate all 5 rules
        function validateAllFiveRules() {
            const playerNames = SoccerConfig.utils.getPlayerNames();
            const violations = [];
            const totalPeriods = SoccerConfig.gameSettings.totalPeriods;

            // Rule 1: Each player sits 1-2 times
            playerNames.forEach(player => {
                const stats = LineupManager.calculatePlayerStats(player);
                const totalSitting = stats.benchPeriods + stats.jerseyPeriods;
                
                if (totalSitting < 1) {
                    violations.push(`RULE 1 VIOLATION: ${player} sits ${totalSitting} times (should sit 1-2 times)`);
                } else if (totalSitting > 2) {
                    violations.push(`RULE 1 VIOLATION: ${player} sits ${totalSitting} times (should sit 1-2 times)`);
                }
            });

            // Rule 2: No consecutive sitting periods
            playerNames.forEach(player => {
                const benchPeriods = [];
                const jerseyPeriods = [];
                
                for (let period = 1; period <= totalPeriods; period++) {
                    const periodData = LineupManager.lineup[period];
                    if (periodData.bench.includes(player)) benchPeriods.push(period);
                    if (periodData.jersey && periodData.jersey.includes(player)) jerseyPeriods.push(period);
                }
                
                const allSittingPeriods = [...benchPeriods, ...jerseyPeriods].sort((a, b) => a - b);
                for (let i = 0; i < allSittingPeriods.length - 1; i++) {
                    if (allSittingPeriods[i + 1] === allSittingPeriods[i] + 1) {
                        violations.push(`RULE 2 VIOLATION: ${player} sits consecutive periods ${allSittingPeriods[i]} and ${allSittingPeriods[i + 1]}`);
                    }
                }
            });

            // Rule 3: Jersey preparation before FIRST consecutive goalkeeper period only
            playerNames.forEach(player => {
                const gkPeriods = [];
                const jerseyPeriods = [];
                
                for (let period = 1; period <= totalPeriods; period++) {
                    const periodData = LineupManager.lineup[period];
                    if (periodData.positions.goalkeeper === player) gkPeriods.push(period);
                    if (periodData.jersey && periodData.jersey.includes(player)) jerseyPeriods.push(period);
                }
                
                if (gkPeriods.length > 0) {
                    gkPeriods.sort((a, b) => a - b);
                    
                    // Find consecutive GK period groups
                    const gkGroups = [];
                    let currentGroup = [gkPeriods[0]];
                    
                    for (let i = 1; i < gkPeriods.length; i++) {
                        if (gkPeriods[i] === gkPeriods[i-1] + 1) {
                            currentGroup.push(gkPeriods[i]);
                        } else {
                            gkGroups.push([...currentGroup]);
                            currentGroup = [gkPeriods[i]];
                        }
                    }
                    gkGroups.push(currentGroup);
                    
                    // Check each group's first period for jersey preparation
                    gkGroups.forEach(group => {
                        const firstGkPeriod = group[0];
                        if (firstGkPeriod > 1) {
                            const expectedJerseyPeriod = firstGkPeriod - 1;
                            if (!jerseyPeriods.includes(expectedJerseyPeriod)) {
                                violations.push(`RULE 3 VIOLATION: ${player} needs jersey preparation in period ${expectedJerseyPeriod} before GK duty starts in period ${firstGkPeriod}`);
                            }
                        }
                    });
                }
            });

            // Rule 4: At least 2 preferred positions per player (if eligible)
            playerNames.forEach(player => {
                const stats = LineupManager.calculatePlayerStats(player);
                const positionsPlayed = Object.keys(stats.positions).filter(pos => stats.positions[pos] > 0);
                const eligiblePositions = SoccerConfig.positions.filter(pos => 
                    SoccerConfig.utils.canPlayerPlayPosition(player, pos)
                );
                
                if (eligiblePositions.length >= 2 && positionsPlayed.length < 2) {
                    violations.push(`RULE 4 VIOLATION: ${player} only played ${positionsPlayed.length} positions (${positionsPlayed.join(', ')}) but is eligible for ${eligiblePositions.length} positions`);
                }
            });

            // Rule 5: Exactly 3 players sitting each period
            for (let period = 1; period <= totalPeriods; period++) {
                const periodData = LineupManager.lineup[period];
                const sittingCount = periodData.bench.length + (periodData.jersey ? periodData.jersey.length : 0);
                
                if (sittingCount !== 3) {
                    violations.push(`RULE 5 VIOLATION: Period ${period} has ${sittingCount} players sitting (should be exactly 3)`);
                }
            }

            return violations;
        }

        // Display rule validation results
        function displayRuleValidation(violations) {
            const validationDiv = document.getElementById('ruleValidation');
            const rules = [
                { id: 1, text: "Each player sits 1-2 times per game", violations: violations.filter(v => v.includes('RULE 1')) },
                { id: 2, text: "No consecutive sitting periods", violations: violations.filter(v => v.includes('RULE 2')) },
                { id: 3, text: "Jersey preparation before first consecutive goalkeeper period", violations: violations.filter(v => v.includes('RULE 3')) },
                { id: 4, text: "At least 2 preferred positions per player", violations: violations.filter(v => v.includes('RULE 4')) },
                { id: 5, text: "Exactly 3 players sitting each period", violations: violations.filter(v => v.includes('RULE 5')) }
            ];

            validationDiv.innerHTML = rules.map(rule => `
                <div class="rule-card">
                    <div class="rule-header">Rule ${rule.id}: ${rule.text}</div>
                    <div class="${rule.violations.length === 0 ? 'success' : 'violation'}">
                        ${rule.violations.length === 0 ? '✅ PASSED' : `❌ ${rule.violations.length} violations`}
                    </div>
                    ${rule.violations.length > 0 ? `
                        <div style="margin-top: 8px; font-size: 12px;">
                            ${rule.violations.map(v => `<div>• ${v.replace('RULE ' + rule.id + ' VIOLATION: ', '')}</div>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Display player statistics
        function displayPlayerStatistics() {
            const statsDiv = document.getElementById('playerStats');
            const playerNames = SoccerConfig.utils.getPlayerNames();

            const playerCards = playerNames.map(player => {
                const stats = LineupManager.calculatePlayerStats(player);
                const totalSitting = stats.benchPeriods + stats.jerseyPeriods;
                const positionsPlayed = Object.keys(stats.positions).filter(pos => stats.positions[pos] > 0);
                const isCompliant = totalSitting >= 1 && totalSitting <= 2;

                return `
                    <div class="player-card ${isCompliant ? 'border-green-200' : 'border-red-200'}">
                        <h4>${player} ${isCompliant ? '✅' : '❌'}</h4>
                        <div>Playing Time: ${stats.totalMinutes} min</div>
                        <div>Sitting Periods: ${totalSitting}/game</div>
                        <div>Positions: ${positionsPlayed.map(pos => SoccerConfig.utils.getPositionAbbrev(pos)).join(', ')}</div>
                    </div>
                `;
            }).join('');

            statsDiv.innerHTML = playerCards;
        }

        // Display lineup visualization
        function displayLineupVisualization() {
            const lineupDiv = document.getElementById('lineupDisplay');
            const fullLineup = LineupManager.getFullLineup();

            let html = '';
            for (let period = 1; period <= SoccerConfig.gameSettings.totalPeriods; period++) {
                const periodData = fullLineup[period];
                const timeInfo = SoccerConfig.utils.getPeriodTime(period);

                html += `
                    <div class="period-card">
                        <div class="period-title">Period ${period}<br><small>${timeInfo.display}</small></div>
                        <div class="position-list">
                            ${SoccerConfig.positions.map(pos => {
                                const player = periodData.positions[pos];
                                const abbrev = SoccerConfig.utils.getPositionAbbrev(pos);
                                return `<div><strong>${abbrev}:</strong> ${player || '-'}</div>`;
                            }).join('')}
                        </div>
                        ${periodData.bench.length > 0 ? `<div class="bench-list">Bench: ${periodData.bench.join(', ')}</div>` : ''}
                        ${periodData.jersey && periodData.jersey.length > 0 ? `<div class="jersey-list">Jersey: ${periodData.jersey.join(', ')}</div>` : ''}
                    </div>
                `;
            }

            lineupDiv.innerHTML = html;
        }

        // Test rule compliance specifically
        function testRuleCompliance() {
            runFullValidation();
        }

        // Stress test the algorithm
        function stressTestAlgorithm() {
            addTestResult('Stress Test Started', 'info', 'Running algorithm 10 times to test consistency...');
            
            const results = [];
            for (let i = 1; i <= 10; i++) {
                try {
                    LineupManager.clearAllPeriods();
                    AutoFillManager.autoFillAll();
                    const violations = validateAllFiveRules();
                    results.push({ run: i, violations: violations.length, success: violations.length === 0 });
                } catch (error) {
                    results.push({ run: i, violations: 'ERROR', success: false, error: error.message });
                }
            }
            
            const successCount = results.filter(r => r.success).length;
            const avgViolations = results.filter(r => typeof r.violations === 'number').reduce((sum, r) => sum + r.violations, 0) / results.length;
            
            addTestResult('Stress Test Completed', successCount === 10 ? 'success' : 'warning', 
                `${successCount}/10 perfect runs, Average violations: ${avgViolations.toFixed(1)}`, { results });
        }

        // Reset and clear
        function resetAndClear() {
            LineupManager.clearAllPeriods();
            testResults = [];
            updateTestDisplay();
            document.getElementById('ruleValidation').innerHTML = '';
            document.getElementById('playerStats').innerHTML = '';
            document.getElementById('lineupDisplay').innerHTML = '';
            addTestResult('System Reset', 'info', 'All data cleared, ready for new tests');
        }
    </script>
</body>
</html>